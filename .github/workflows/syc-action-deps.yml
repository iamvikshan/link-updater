name: Sync Action Dependencies

on:
  push:
    branches: [main]
    paths:
      - "package.json"
      - "bun.lock"
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Bun and install dependencies
        uses: iamvikshan/.github/.github/actions/setup-bun@main

      - name: Sync action.yml dependencies
        id: sync
        run: |
          # Run the sync script
          bun scripts/sync-action-deps.ts

      - name: Commit and push changes
        if: steps.sync.outputs.changes == 'true'
        run: |
          git config --global user.email "${{ github.repository_owner_id }}+${{ github.repository_owner }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"
          git add action.yml
          git commit -m "chore: sync action.yml dependencies with package.json

          ${{ steps.sync.outputs.changes-summary }}"
          git push

      - name: Validation summary
        run: |
          if [ "${{ steps.sync.outputs.changes }}" = "true" ]; then
            echo "✅ action.yml dependencies synced and committed"
          else
            echo "✅ action.yml dependencies already in sync"
          fi
